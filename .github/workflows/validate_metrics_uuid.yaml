name: Check Unique UUIDs in Metrics

on:
  pull_request:
    branches: [ main ]
    # Only trigger when files in the metrics folder change
    paths:
      - 'metrics/**/*.yaml'

jobs:
  validate-uuids:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install PyYAML

      - name: Scan for Duplicate IDs
        run: |
          python -c '
          import yaml
          import glob
          import sys
          import os

          ids = {}
          duplicates = []
          
          # Only scan .yaml files within the metrics folder and its subdirectories
          search_path = "metrics/**/*.yaml"
          files = glob.glob(search_path, recursive=True)

          print(f"Scanning {len(files)} files in metrics/...")

          for filename in files:
              try:
                  with open(filename, "r") as f:
                      # Using safe_load_all to handle potential multi-document YAML files
                      data_list = yaml.safe_load_all(f)
                      
                      for data in data_list:
                          # Check if the document is a dictionary and contains an "id" field
                          if isinstance(data, dict) and "id" in data:
                              val = str(data["id"]).strip().lower()
                              if val in ids:
                                  duplicates.append(f"Conflict for ID \"{val}\" found in \n-{filename} and \n-{ids[val]}")
                              else:
                                  ids[val] = filename
              except Exception as e:
                  print(f"Error reading {filename}: {e}")

          if duplicates:
              print("❌ Duplicate UUIDs detected in metrics folder:")
              for d in duplicates:
                  print(d)
              sys.exit(1)
          else:
              print("✅ All UUIDs are unique within the metrics folder.")
          '