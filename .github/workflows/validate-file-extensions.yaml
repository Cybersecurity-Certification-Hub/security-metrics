name: "Validate file extensions"

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  prohibit-yml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect added files and fail on .yml
        shell: bash
        run: |
          set -euo pipefail

          # Determine the correct git SHAs to compare based on event type
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs: compare base branch (target) with head branch (your changes)
            ADDED_FILES=$(git diff --name-only --diff-filter=A ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          else
            # For pushes: compare previous commit with current commit
            BASE="${{ github.event.before }}"
            # Handle initial push (then there is no "before" event/commit)
            BASE="${BASE:0:1}" = "0" ? "4b825dc642cb6eb9a060e54bf8d69288fbee4904" : "$BASE"
            ADDED_FILES=$(git diff --name-only --diff-filter=A "$BASE" ${{ github.sha }})
          fi

          # Find any newly added files with .yml extension
          YML_FILES=$(echo "$ADDED_FILES" | grep '\.yml$' || true)

          # Fail if .yml files were detected
          if [ -n "$YML_FILES" ]; then
            echo "::error title=.yml files detected::.yml files were added (use .yaml instead):"
            echo "$YML_FILES"
            exit 1
          fi
